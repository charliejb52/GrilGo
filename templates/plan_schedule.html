{% extends "base.html" %}
{% block content %}
<h2>Plan Shifts – {{ year }}-{{ "%02d"|format(month) }}</h2>

<div class="calendar-nav mb-3">
    <a href="{{ url_for('plan_schedule', year=prev_year, month=prev_month) }}" class="btn btn-secondary">← Previous</a>
    <span class="mx-3">{{ year }} - {{ month }}</span>
    <a href="{{ url_for('plan_schedule', year=next_year, month=next_month) }}" class="btn btn-secondary">Next →</a>
</div>

<table class="table table-bordered calendar">
    <thead>
        <tr>
            {% for weekday in ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"] %}
                <th>
                    {{ weekday }}
                    <form method="POST" action="{{ url_for('add_weekday_shifts', year=year, month=month) }}">
                        <input type="hidden" name="weekday" value="{{ loop.index0 }}"> <!-- 0=Mon, 6=Sun -->
                        <select name="template_id" class="form-control form-control-sm mb-1">
                            {% for t in templates %}
                                <option value="{{ t.id }}">{{ t.name }} ({{ t.start_time.strftime("%H:%M") }}–{{ t.end_time.strftime("%H:%M") }}, {{ t.role_type }})</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-sm btn-success">Add</button>
                    </form>
                </th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        <tr>
        {% for d in days %}
            {% if d.month != month %}
                <td class="bg-light"></td>
            {% else %}
                <td valign="top">
                    <strong>{{ d.day }}</strong>
                    {% set day_key = d.strftime("%Y-%m-%d") %}
                    <div class="shift-list">
                        {% for shift in shifts_by_day.get(day_key, []) %}
                            <div class="shift-entry
                                {% if shift.worker_id is none %} unassigned{% endif %}
                                {% if shift.role_type == 'cart' %} cart-shift{% endif %}
                                {% if shift.role_type == 'turn_grill' %} turn-grill-shift{% endif %}
                            ">
                                {{ shift.start_time.strftime("%H:%M") }}–{{ shift.end_time.strftime("%H:%M") }}
                                <em>{{ shift.role_type }}</em>
                                {% if shift.worker %}
                                    ({{ shift.worker.name }})
                                {% else %}
                                    <strong>Unassigned</strong>
                                {% endif %}

                                <!-- Delete button -->
                                <form method="POST" action="{{ url_for('delete_shift', shift_id=shift.id) }}" style="display:inline;">
                                    <button type="submit" class="btn btn-sm btn-danger" style="padding:0 4px; font-size:0.7em;">✕</button>
                                </form>
                            </div>

                        {% endfor %}
                    </div>

                    <!-- Add new shift form (inline per day) -->
                    <form method="POST" action="{{ url_for('plan_schedule', year=year, month=month) }}">
                        <input type="hidden" name="date" value="{{ d }}">
                        <select name="template_id" class="form-control form-control-sm mb-1">
                            {% for t in templates %}
                                <option value="{{ t.id }}">{{ t.name }} ({{ t.start_time.strftime("%H:%M") }}–{{ t.end_time.strftime("%H:%M") }}, {{ t.role_type }})</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-sm btn-primary">Add</button>
                    </form>
                </td>
            {% endif %}

            {% if d.weekday() == 6 and not loop.last %}
                </tr><tr>
            {% endif %}
        {% endfor %}
        </tr>
    </tbody>
</table>
<a href="{{ url_for('dashboard_manager') }}" class="btn btn-secondary">Home</a>
<a href="{{ url_for('shift_templates') }}" class="btn btn-info mb-3">Manage Shift Templates</a>
<form method="POST" action="{{ url_for('delete_all_shifts', year=year, month=month) }}" 
      onsubmit="return confirm('Are you sure you want to delete ALL shifts for this month?');">
    <button type="submit" class="btn btn-danger mb-3">Delete All Shifts</button>
</form>

<style>
.calendar th, .calendar td {
    width: 14%;
    height: 160px;
    vertical-align: top;
}
.shift-entry {
    background: #f0f8ff;
    margin-bottom: 4px;
    padding: 2px 4px;
    border-radius: 4px;
    font-size: 0.8em;
}

.shift-entry.unassigned {
    background: #ffe0e0;
    border-left: 3px solid red;
    color: #900;
    font-weight: bold;
}

.shift-entry.cart-shift {
    background: #e0f0ff;
    border-left: 3px solid blue;
}

.shift-entry.turn-grill-shift {
    background: #fff4e0;
    border-left: 3px solid orange;
}

.shift-entry form {
    display: inline;
    margin-left: 4px;
}

.shift-entry button {
    background: none;
    border: none;
    color: red;
    cursor: pointer;
    font-weight: bold;
}
</style>
{% endblock %}